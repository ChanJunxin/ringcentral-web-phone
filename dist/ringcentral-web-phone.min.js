!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t(require("sip.js"),require("getstats")):"function"==typeof define&&define.amd?define(["sip.js","getstats"],t):"object"==typeof exports?exports.WebPhone=t(require("sip.js"),require("getstats")):(e.RingCentral=e.RingCentral||{},e.RingCentral.WebPhone=t(e.SIP,e.getStats))}(window,function(n,r){return(s={},i.m=o=[function(e,t){e.exports=n},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.defaultMediaConstraints=t.responseTimeout=t.uuidKey=t.messages=void 0,t.messages={park:{reqid:1,command:"callpark"},startRecord:{reqid:2,command:"startcallrecord"},stopRecord:{reqid:3,command:"stopcallrecord"},flip:{reqid:3,command:"callflip",target:""},monitor:{reqid:4,command:"monitor"},barge:{reqid:5,command:"barge"},whisper:{reqid:6,command:"whisper"},takeover:{reqid:7,command:"takeover"},toVoicemail:{reqid:11,command:"toVoicemail"},ignore:{reqid:12,command:"ignore"},receiveConfirm:{reqid:17,command:"receiveConfirm"},replyWithMessage:{reqid:14,command:"replyWithMessage"}},t.uuidKey="rc-webPhone-uuid",t.responseTimeout=6e4,t.defaultMediaConstraints={audio:!0,video:!1}},function(e,t,n){"use strict";var r=this&&this.__awaiter||function(e,s,a,c){return new(a=a||Promise)(function(t,n){function r(e){try{o(c.next(e))}catch(e){n(e)}}function i(e){try{o(c.throw(e))}catch(e){n(e)}}function o(e){e.done?t(e.value):function(t){return t instanceof a?t:new a(function(e){e(t)})}(e.value).then(r,i)}o((c=c.apply(e,s||[])).next())})},i=this&&this.__generator||function(n,r){var i,o,s,e,a={label:0,sent:function(){if(1&s[0])throw s[1];return s[1]},trys:[],ops:[]};return e={next:t(0),throw:t(1),return:t(2)},"function"==typeof Symbol&&(e[Symbol.iterator]=function(){return this}),e;function t(t){return function(e){return function(t){if(i)throw new TypeError("Generator is already executing.");for(;a;)try{if(i=1,o&&(s=2&t[0]?o.return:t[0]?o.throw||((s=o.return)&&s.call(o),0):o.next)&&!(s=s.call(o,t[1])).done)return s;switch(o=0,s&&(t=[2&t[0],s.value]),t[0]){case 0:case 1:s=t;break;case 4:return a.label++,{value:t[1],done:!1};case 5:a.label++,o=t[1],t=[0];continue;case 7:t=a.ops.pop(),a.trys.pop();continue;default:if(!(s=0<(s=a.trys).length&&s[s.length-1])&&(6===t[0]||2===t[0])){a=0;continue}if(3===t[0]&&(!s||t[1]>s[0]&&t[1]<s[3])){a.label=t[1];break}if(6===t[0]&&a.label<s[1]){a.label=s[1],s=t;break}if(s&&a.label<s[2]){a.label=s[2],a.ops.push(t);break}s[2]&&a.ops.pop(),a.trys.pop();continue}t=r.call(n,a)}catch(e){t=[6,e],o=0}finally{i=s=0}if(5&t[0])throw t[1];return{value:t[0]?t[1]:void 0,done:!0}}([t,e])}}};Object.defineProperty(t,"__esModule",{value:!0}),t.extend=t.delay=t.uuid=void 0,t.uuid=function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var t=16*Math.random()|0;return("x"===e?t:3&t|8).toString(16)})},t.delay=function(t){return r(void 0,void 0,void 0,function(){return i(this,function(e){return[2,new Promise(function(e){return setTimeout(e,t)})]})})},t.extend=function(e,t){return void 0===e&&(e={}),void 0===t&&(t={}),Object.assign(e||{},t||{})}},function(e,t,n){"use strict";var r,i,o,s,d=this&&this.__awaiter||function(e,s,a,c){return new(a=a||Promise)(function(t,n){function r(e){try{o(c.next(e))}catch(e){n(e)}}function i(e){try{o(c.throw(e))}catch(e){n(e)}}function o(e){e.done?t(e.value):function(t){return t instanceof a?t:new a(function(e){e(t)})}(e.value).then(r,i)}o((c=c.apply(e,s||[])).next())})},l=this&&this.__generator||function(n,r){var i,o,s,e,a={label:0,sent:function(){if(1&s[0])throw s[1];return s[1]},trys:[],ops:[]};return e={next:t(0),throw:t(1),return:t(2)},"function"==typeof Symbol&&(e[Symbol.iterator]=function(){return this}),e;function t(t){return function(e){return function(t){if(i)throw new TypeError("Generator is already executing.");for(;a;)try{if(i=1,o&&(s=2&t[0]?o.return:t[0]?o.throw||((s=o.return)&&s.call(o),0):o.next)&&!(s=s.call(o,t[1])).done)return s;switch(o=0,s&&(t=[2&t[0],s.value]),t[0]){case 0:case 1:s=t;break;case 4:return a.label++,{value:t[1],done:!1};case 5:a.label++,o=t[1],t=[0];continue;case 7:t=a.ops.pop(),a.trys.pop();continue;default:if(!(s=0<(s=a.trys).length&&s[s.length-1])&&(6===t[0]||2===t[0])){a=0;continue}if(3===t[0]&&(!s||t[1]>s[0]&&t[1]<s[3])){a.label=t[1];break}if(6===t[0]&&a.label<s[1]){a.label=s[1],s=t;break}if(s&&a.label<s[2]){a.label=s[2],a.ops.push(t);break}s[2]&&a.ops.pop(),a.trys.pop();continue}t=r.call(n,a)}catch(e){t=[6,e],o=0}finally{i=s=0}if(5&t[0])throw t[1];return{value:t[0]?t[1]:void 0,done:!0}}([t,e])}}};Object.defineProperty(t,"__esModule",{value:!0}),t.MediaStreams=t.MediaStreamsImpl=t.RTPReport=t.Browsers=void 0,(i=r=r||{}).new="mediaConnectionStateNew",i.checking="mediaConnectionStateChecking",i.connected="mediaConnectionStateConnected",i.completed="mediaConnectionStateCompleted",i.failed="mediaConnectionStateFailed",i.disconnected="mediaConnectionStateDisconnected",i.closed="mediaConnectionStateClosed",(s=o=t.Browsers||(t.Browsers={})).MSIE="IE",s.Chrome="Chrome",s.Firefox="Firefox",s.Safari="Safari",s.Opera="Opera";var a=function(){this.outboundRtpReport={},this.inboundRtpReport={},this.rttMS={}};t.RTPReport=a;var c=(Object.defineProperty(u.prototype,"onRTPStat",{set:function(e){this.mediaStreamsImpl.onRTPStat=e},enumerable:!1,configurable:!0}),Object.defineProperty(u.prototype,"onMediaConnectionStateChange",{set:function(e){this.mediaStreamsImpl.onMediaConnectionStateChange=e},enumerable:!1,configurable:!0}),u);function u(e){this.mediaStreamsImpl=new p(e),this.release=this.mediaStreamsImpl.release.bind(this.mediaStreamsImpl),this.reconnectMedia=this.mediaStreamsImpl.reconnectMedia.bind(this.mediaStreamsImpl),this.getMediaStats=this.mediaStreamsImpl.getMediaStats.bind(this.mediaStreamsImpl),this.stopMediaStats=this.mediaStreamsImpl.stopMediaStats.bind(this.mediaStreamsImpl)}t.MediaStreams=c,t.default=c;var p=(h.prototype.getMediaStats=function(e,t){var n=this;void 0===e&&(e=null),void 0===t&&(t=1e3),e&&(this.onRTPStat=e),this.mediaStatsTimer&&(clearTimeout(this.mediaStatsTimer),this.mediaStatsTimer=null),this.mediaStatsTimer=setInterval(function(){n.mediaStatsTimerCallback()},t)},h.prototype.mediaStatsTimerCallback=function(){var e=this.session.sessionDescriptionHandler.peerConnection;if(e){var t=e.iceConnectionState;if("connected"===t||"completed"===t){var n=this.session.listeners("rtpStat");!this.session.onRTPStat&&!this.onRTPStat&&n.length<=0?this.rcWPLoge(this.ktag,'No callback to accept receive media report. usage: session.on("rtpStat") = function(report) or session.onRTPStat = function(report) or set a mediaCallback as a paramter'):this.getRTPReport(new a)}else this.preRTT.currentRoundTripTime=0}else this.rcWPLoge(this.ktag,"the peer connection cannot be null")},h.prototype.stopMediaStats=function(){this.mediaStatsTimer&&(clearTimeout(this.mediaStatsTimer),this.onRTPStat=null)},Object.defineProperty(h.prototype,"tag",{get:function(){return this.ktag},enumerable:!1,configurable:!0}),h.prototype.onPeerConnectionStateChange=function(e){var t="unknown";r.hasOwnProperty(e.peerConnection.iceConnectionState)?(t=r[e.peerConnection.iceConnectionState],this.onMediaConnectionStateChange?this.onMediaConnectionStateChange(this.session,t):this.session&&this.session.onMediaConnectionStateChange?this.session.onMediaConnectionStateChange(this.session,t):this.session.emit(t)):this.rcWPLogd(this.tag,"Unknown peerConnection state: "+e.peerConnection.iceConnectionState),this.rcWPLogd(this.tag,"peerConnection State: "+t)},h.prototype.reconnectMedia=function(c){var u=this;return new Promise(function(s,a){return d(this,void 0,void 0,function(){var t,n,r,i,o;return l(this,function(e){switch(e.label){case 0:if(!u.session)return[3,6];t={offerToReceiveAudio:1,offerToReceiveVideo:0,iceRestart:!0},n=c&&c.RTCOptions||t,(c=c||{}).extraHeaders||(c.extraHeaders=u.session.ua.defaultHeaders),c.eventHandlers={succeeded:s,failed:a},r=u.session.sessionDescriptionHandler.peerConnection,i=void 0,e.label=1;case 1:return e.trys.push([1,4,,5]),[4,r.createOffer(n)];case 2:return i=e.sent(),u.session.sessionDescriptionHandler.on("iceCandidate",u.onIceCandidate),[4,r.setLocalDescription(i)];case 3:return e.sent(),u.rcWPLogd(u.tag,"reconnecting media"),s("reconnecting media"),[3,5];case 4:return o=e.sent(),u.rcWPLoge(u.tag,o),a(o),[3,5];case 5:return[3,7];case 6:u.rcWPLoge(u.tag,"The session cannot be empty"),e.label=7;case 7:return[2]}})})})},h.prototype.getRTPReport=function(n){var t=this,r=this;r.session.sessionDescriptionHandler.peerConnection.getStats().then(function(e){e.forEach(function(t){switch(t.type){case"inbound-rtp":Object.keys(t).forEach(function(e){switch(e){case"bytesReceived":case"packetsReceived":case"jitter":case"packetsLost":case"fractionLost":case"mediaType":n.inboundRtpReport[e]=t[e];break;case"roundTripTime":n.rttMS[e]=t[e]}});break;case"outbound-rtp":Object.keys(t).forEach(function(e){switch(e){case"bytesSent":case"packetsSent":case"mediaType":n.outboundRtpReport[e]=t[e]}});break;case"candidate-pair":Object.keys(t).forEach(function(e){switch(e){case"currentRoundTripTime":n.rttMS[e]=t[e]}});break;case"media-source":n.outboundRtpReport.rtpLocalAudioLevel=t.audioLevel?t.audioLevel:0;break;case"track":if(!t.remoteSource)break;n.inboundRtpReport.rtpRemoteAudioLevel=t.audioLevel?t.audioLevel:0}}),n.rttMS.hasOwnProperty("currentRoundTripTime")?n.rttMS.currentRoundTripTime=Math.round(1e3*n.rttMS.currentRoundTripTime):n.rttMS.hasOwnProperty("roundTripTime")?(n.rttMS.currentRoundTripTime=n.rttMS.roundTripTime,delete n.rttMS.roundTripTime):n.rttMS.currentRoundTripTime=r.preRTT.currentRoundTripTime,n.rttMS.hasOwnProperty("currentRoundTripTime")&&(r.preRTT.currentRoundTripTime=n.rttMS.currentRoundTripTime),r.session&&(r.session.onRTPStat?r.session.onRTPStat(n,r.session):r.onRTPStat?r.onRTPStat(n,r.session):r.session.emit("rtpStat",n,r.session))}).catch(function(e){t.rcWPLoge(r.ktag,JSON.stringify(e))})},h.prototype.browser=function(){return 0<=navigator.userAgent.search("MSIE")?o.MSIE:0<=navigator.userAgent.search("Chrome")?o.Chrome:0<=navigator.userAgent.search("Firefox")?o.Firefox:0<=navigator.userAgent.search("Safari")&&navigator.userAgent.search("Chrome")<0?o.Safari:0<=navigator.userAgent.search("Opera")?o.Opera:"unknown"},h.prototype.release=function(){this.mediaStatsTimer&&(clearTimeout(this.mediaStatsTimer),this.mediaStatsTimer=null),this.session&&(this.session.sessionDescriptionHandler.removeListener("iceConnection",this.onStateChange),this.session.sessionDescriptionHandler.removeListener("iceConnectionChecking",this.onStateChange),this.session.sessionDescriptionHandler.removeListener("iceConnectionConnected",this.onStateChange),this.session.sessionDescriptionHandler.removeListener("iceConnectionCompleted",this.onStateChange),this.session.sessionDescriptionHandler.removeListener("iceConnectionFailed",this.onStateChange),this.session.sessionDescriptionHandler.removeListener("iceConnectionDisconnected",this.onStateChange),this.session.sessionDescriptionHandler.removeListener("iceConnectionClosed",this.onStateChange))},h.prototype.rcWPLoge=function(e,t){this.session&&this.session.logger.error(e+" "+t)},h.prototype.rcWPLogd=function(e,t){this.session&&this.session.logger.log(e+" "+t)},h);function h(e){var t=this;if(this.ktag="MediaStreams",this.onIceCandidate=function(e){null===e.candidate&&(t.rcWPLogd(t.tag,"ice candidate completed for reconnect media"),t.session.sessionDescriptionHandler.off("iceCandidate",t.onIceCandidate),t.session.reinvite())},this.ktag="MediaStreams",!e)throw this.rcWPLoge(this.ktag,"The session cannot be null!"),new Error("Fail to create the media session. session is null or undefined!");this.session=e,this.onMediaConnectionStateChange=null,this.onStateChange=this.onPeerConnectionStateChange.bind(this),this.session&&this.session.sessionDescriptionHandler&&(this.session.sessionDescriptionHandler.on("iceConnection",this.onStateChange),this.session.sessionDescriptionHandler.on("iceConnectionChecking",this.onStateChange),this.session.sessionDescriptionHandler.on("iceConnectionConnected",this.onStateChange),this.session.sessionDescriptionHandler.on("iceConnectionCompleted",this.onStateChange),this.session.sessionDescriptionHandler.on("iceConnectionFailed",this.onStateChange),this.session.sessionDescriptionHandler.on("iceConnectionDisconnected",this.onStateChange),this.session.sessionDescriptionHandler.on("iceConnectionClosed",this.onStateChange)),this.isChrome=this.browser()===o.Chrome,this.isFirefox=this.browser()===o.Firefox,this.isSafari=this.browser()===o.Safari,this.preRTT={currentRoundTripTime:0},this.isChrome||this.isFirefox||this.isSafari||this.rcWPLoge(this.ktag,"The web browser "+this.browser()+" is not in the recommended list [Chrome, Safari, Firefox] !")}t.MediaStreamsImpl=p},function(e,t,n){"use strict";var r,i,o,s,a;Object.defineProperty(t,"__esModule",{value:!0}),(r=t.DialogStatus||(t.DialogStatus={}))[r.STATUS_EARLY=1]="STATUS_EARLY",r[r.STATUS_CONFIRMED=2]="STATUS_CONFIRMED",(i=t.SessionStatus||(t.SessionStatus={}))[i.STATUS_NULL=0]="STATUS_NULL",i[i.STATUS_INVITE_SENT=1]="STATUS_INVITE_SENT",i[i.STATUS_1XX_RECEIVED=2]="STATUS_1XX_RECEIVED",i[i.STATUS_INVITE_RECEIVED=3]="STATUS_INVITE_RECEIVED",i[i.STATUS_WAITING_FOR_ANSWER=4]="STATUS_WAITING_FOR_ANSWER",i[i.STATUS_ANSWERED=5]="STATUS_ANSWERED",i[i.STATUS_WAITING_FOR_PRACK=6]="STATUS_WAITING_FOR_PRACK",i[i.STATUS_WAITING_FOR_ACK=7]="STATUS_WAITING_FOR_ACK",i[i.STATUS_CANCELED=8]="STATUS_CANCELED",i[i.STATUS_TERMINATED=9]="STATUS_TERMINATED",i[i.STATUS_ANSWERED_WAITING_FOR_PRACK=10]="STATUS_ANSWERED_WAITING_FOR_PRACK",i[i.STATUS_EARLY_MEDIA=11]="STATUS_EARLY_MEDIA",i[i.STATUS_CONFIRMED=12]="STATUS_CONFIRMED",(o=t.TransactionStatus||(t.TransactionStatus={}))[o.STATUS_TRYING=1]="STATUS_TRYING",o[o.STATUS_PROCEEDING=2]="STATUS_PROCEEDING",o[o.STATUS_CALLING=3]="STATUS_CALLING",o[o.STATUS_ACCEPTED=4]="STATUS_ACCEPTED",o[o.STATUS_COMPLETED=5]="STATUS_COMPLETED",o[o.STATUS_TERMINATED=6]="STATUS_TERMINATED",o[o.STATUS_CONFIRMED=7]="STATUS_CONFIRMED",(s=t.TypeStrings||(t.TypeStrings={}))[s.AckClientTransaction=0]="AckClientTransaction",s[s.ClientContext=1]="ClientContext",s[s.ConfigurationError=2]="ConfigurationError",s[s.Dialog=3]="Dialog",s[s.DigestAuthentication=4]="DigestAuthentication",s[s.DTMF=5]="DTMF",s[s.IncomingMessage=6]="IncomingMessage",s[s.IncomingRequest=7]="IncomingRequest",s[s.IncomingResponse=8]="IncomingResponse",s[s.InvalidStateError=9]="InvalidStateError",s[s.InviteClientContext=10]="InviteClientContext",s[s.InviteClientTransaction=11]="InviteClientTransaction",s[s.InviteServerContext=12]="InviteServerContext",s[s.InviteServerTransaction=13]="InviteServerTransaction",s[s.Logger=14]="Logger",s[s.LoggerFactory=15]="LoggerFactory",s[s.MethodParameterError=16]="MethodParameterError",s[s.NameAddrHeader=17]="NameAddrHeader",s[s.NonInviteClientTransaction=18]="NonInviteClientTransaction",s[s.NonInviteServerTransaction=19]="NonInviteServerTransaction",s[s.NotSupportedError=20]="NotSupportedError",s[s.OutgoingRequest=21]="OutgoingRequest",s[s.Parameters=22]="Parameters",s[s.PublishContext=23]="PublishContext",s[s.ReferClientContext=24]="ReferClientContext",s[s.ReferServerContext=25]="ReferServerContext",s[s.RegisterContext=26]="RegisterContext",s[s.RenegotiationError=27]="RenegotiationError",s[s.RequestSender=28]="RequestSender",s[s.ServerContext=29]="ServerContext",s[s.Session=30]="Session",s[s.SessionDescriptionHandler=31]="SessionDescriptionHandler",s[s.SessionDescriptionHandlerError=32]="SessionDescriptionHandlerError",s[s.SessionDescriptionHandlerObserver=33]="SessionDescriptionHandlerObserver",s[s.Subscription=34]="Subscription",s[s.Transport=35]="Transport",s[s.TransportError=36]="TransportError",s[s.UA=37]="UA",s[s.URI=38]="URI",(a=t.UAStatus||(t.UAStatus={}))[a.STATUS_INIT=0]="STATUS_INIT",a[a.STATUS_STARTING=1]="STATUS_STARTING",a[a.STATUS_READY=2]="STATUS_READY",a[a.STATUS_USER_CLOSED=3]="STATUS_USER_CLOSED",a[a.STATUS_NOT_READY=4]="STATUS_NOT_READY"},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=n(4),i=(o.prototype.trackAdded=function(){this.session.emit("trackAdded")},o.prototype.directionChanged=function(){this.session.emit("directionChanged")},o);function o(e,t){this.type=r.TypeStrings.SessionDescriptionHandlerObserver,this.session=e,this.options=t}t.SessionDescriptionHandlerObserver=i},function(e,t,n){"use strict";var r=this&&this.__createBinding||(Object.create?function(e,t,n,r){void 0===r&&(r=n),Object.defineProperty(e,r,{enumerable:!0,get:function(){return t[n]}})}:function(e,t,n,r){void 0===r&&(r=n),e[r]=t[n]}),i=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),o=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)Object.hasOwnProperty.call(e,n)&&r(t,e,n);return i(t,e),t};Object.defineProperty(t,"__esModule",{value:!0});var T=n(7),y=n(0),b=n(1),w=n(2),s=o(n(3)),_=n(14),R=n(5),I=n(18).version,a=(c.version="0.8.1",c.uuid=w.uuid,c.delay=w.delay,c.extend=w.extend,c.MediaStreams=s.default,c.MediaStreamsImpl=s.MediaStreamsImpl,c);function c(e,t){void 0===e&&(e={}),void 0===t&&(t={}),this.sipInfo=e.sipInfo[0]||e.sipInfo,this.sipFlags=e.sipFlags,this.uuidKey=t.uuidKey||b.uuidKey;var n=t.uuid||localStorage.getItem(this.uuidKey)||w.uuid();localStorage.setItem(this.uuidKey,n),this.appKey=t.appKey,this.appName=t.appName,this.appVersion=t.appVersion;var r=navigator.userAgent.match(/\((.*?)\)/),i=(r&&r.length&&r[1]).replace(/[^a-zA-Z0-9.:_]+/g,"-")||"",o=(t.appName?t.appName+(t.appVersion?"/"+t.appVersion:"")+" ":"")+(i||"")+" RCWEBPHONE/"+I,s=t.modifiers||[];!1!==t.enableDefaultModifiers&&(s.push(y.Web.Modifiers.stripG722),s.push(y.Web.Modifiers.stripTcpCandidates)),t.enableMidLinesInSDP&&s.push(y.Web.Modifiers.addMidLines);var a="unified-plan";t.enablePlanB&&(a="plan-b");var c=t.stunServers||this.sipInfo.stunServers||["stun:74.125.194.127:19302"],u=[];c.forEach(function(e){e=/^(stun:)/.test(e)?e:"stun:"+e,u.push({urls:e})});var d=t.sessionDescriptionHandlerFactoryOptions||{peerConnectionOptions:{iceCheckingTimeout:this.sipInfo.iceCheckingTimeout||this.sipInfo.iceGatheringTimeout||500,rtcConfiguration:{sdpSemantics:a,iceServers:u}},constraints:t.mediaConstraints||b.defaultMediaConstraints,modifiers:s},l=navigator.userAgent.toLowerCase(),p=!1;-1<l.indexOf("safari")&&l.indexOf("chrome")<0||-1<l.indexOf("firefox")&&l.indexOf("chrome")<0&&(p=!0),p&&(d.alwaysAcquireMediaFirst=!0);var h=e.sipErrorCodes&&e.sipErrorCodes.length?e.sipErrorCodes:["408","502","503","504"],f=[];this.sipInfo.outboundProxy&&this.sipInfo.transport&&f.push({wsUri:this.sipInfo.transport.toLowerCase()+"://"+this.sipInfo.outboundProxy,weight:10}),this.sipInfo.outboundProxyBackup&&this.sipInfo.transport&&f.push({wsUri:this.sipInfo.transport.toLowerCase()+"://"+this.sipInfo.outboundProxyBackup,weight:0}),f=f.length?f:this.sipInfo.wsServers;var g=t.maxReconnectionAttemptsNoBackup||15,m=t.maxReconnectionAttemptsWithBackup||10,v=t.reconnectionTimeoutNoBackup||5,S=t.reconnectionTimeoutWithBackup||4,C={uri:"sip:"+this.sipInfo.username+"@"+this.sipInfo.domain,transportOptions:{wsServers:f,traceSip:!0,maxReconnectionAttempts:1===f.length?g:m,reconnectionTimeout:1===f.length?v:S,connectionTimeout:5},authorizationUser:this.sipInfo.authorizationId,password:this.sipInfo.password,log:{level:t.logLevel||1,builtinEnabled:void 0===t.builtinEnabled||t.builtinEnabled,connector:t.connector||null},domain:this.sipInfo.domain,autostart:!1,register:!0,userAgentString:o,sessionDescriptionHandlerFactoryOptions:d,sessionDescriptionHandlerFactory:function(e,t){var n=e.ua.getLogger("sip.invitecontext.defaultSessionDescriptionHandler",e.id),r=new R.SessionDescriptionHandlerObserver(e,t);return new _.DefaultSessionDescriptionHandler(n,r,d)},allowLegacyNotifications:!0,registerOptions:{instanceId:t.instanceId||void 0,regId:t.regId||void 0}};t.sipErrorCodes=h,t.switchBackInterval=this.sipInfo.switchBackInterval,this.userAgent=T.patchUserAgent(new y.UA(C),this.sipInfo,t,n)}t.default=a},function(e,t,n){"use strict";var i=this&&this.__assign||function(){return(i=Object.assign||function(e){for(var t,n=1,r=arguments.length;n<r;n++)for(var i in t=arguments[n])Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i]);return e}).apply(this,arguments)},o=this&&this.__spreadArrays||function(){for(var e=0,t=0,n=arguments.length;t<n;t++)e+=arguments[t].length;var r=Array(e),i=0;for(t=0;t<n;t++)for(var o=arguments[t],s=0,a=o.length;s<a;s++,i++)r[i]=o[s];return r};Object.defineProperty(t,"__esModule",{value:!0}),t.patchUserAgent=void 0;var s=n(8),a=n(9),c=n(13);function u(e){return e.body=e.body||"",'<Msg><Hdr SID="'+e.sid+'" Req="'+e.request+'" From="'+e.from+'" To="'+e.to+'" Cmd="'+e.reqid+'"/> <Bdy Cln="'+this.sipInfo.authorizationId+'" '+e.body+"/></Msg>"}function d(t,i){var o=this,s={contentType:"x-rc/agent",extraHeaders:[]};return s.extraHeaders.push("P-rc-ws: "+this.contact),new Promise(function(n,r){var e=o.message(t,i,s);e.once("accepted",function(e,t){return n(e)}),e.once("failed",function(e,t){return r(new Error(t))})})}t.patchUserAgent=function(r,e,t,n){return r.defaultHeaders=["P-rc-endpoint-id: "+n,"Client-id:"+t.appKey],r.media={},r.enableQos=t.enableQos,r.enableMediaReportLogging=t.enableMediaReportLogging,r.qosCollectInterval=t.qosCollectInterval||5e3,t.media&&t.media.remote&&t.media.local?(r.media.remote=t.media.remote,r.media.local=t.media.local):r.media=null,r.sipInfo=e,r.__invite=r.invite,r.invite=function(e,t){void 0===t&&(t={});t.extraHeaders=(t.extraHeaders||[]).concat(this.defaultHeaders),t.extraHeaders.push("P-Asserted-Identity: sip:"+(t.fromNumber||this.sipInfo.username)+"@"+this.sipInfo.domain),t.homeCountryId&&t.extraHeaders.push("P-rc-country-id: "+t.homeCountryId);return t.RTCConstraints=t.RTCConstraints||{optional:[{DtlsSrtpKeyAgreement:"true"}]},this.audioHelper.playOutgoing(!0),this.logger.log("Invite to "+e+" created with playOutgoing set to true"),a.patchSession(this.__invite(e,t))}.bind(r),r.__register=r.register,r.register=function(e){void 0===e&&(e={});return this.__register.call(this,i(i({},e),{extraHeaders:o(e.extraHeaders||[],this.defaultHeaders)}))}.bind(r),r.__unregister=r.unregister,r.unregister=function(e){void 0===e&&(e={});return this.__unregister.call(this,i(i({},e),{extraHeaders:o(e.extraHeaders||[],this.defaultHeaders)}))}.bind(r),r.audioHelper=new s.AudioHelper(t.audioHelper),r.__transportConstructor=r.configuration.transportConstructor,r.configuration.transportConstructor=c.TransportConstructorWrapper(r.__transportConstructor,t),r.onSession=t.onSession||null,r.createRcMessage=u,r.sendMessage=d,r.__onTransportConnected=r.onTransportConnected,r.onTransportConnected=function(){if(this.configuration.register)return this.register()}.bind(r),r.on("invite",function(t){r.audioHelper.playIncoming(!0),a.patchSession(t),a.patchIncomingSession(t),t.logger.log("UA recieved incoming call invite"),t._sendReceiveConfirmPromise=t.sendReceiveConfirm().then(function(){t.logger.log("sendReceiveConfirm success")}).catch(function(e){t.logger.error("failed to send receive confirmation via SIP MESSAGE due to "+e)})}),r.on("registrationFailed",function(e){if(e){var t=e.data||e;t&&"string"==typeof t&&r.transport.isSipErrorCode(t)&&r.transport.onSipErrorCode(),r.logger.warn("UA Registration Failed")}}),r.on("notify",function(e){var t=e.request,n=t&&t.headers&&t.headers.Event&&t.headers.Event[0];n&&"check-sync"===n.raw&&r.emit("provisionUpdate"),r.logger.log("UA recieved notify")}),r.start(),r}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.AudioHelper=void 0;var r=(i.prototype._playSound=function(e,t,n){if(!this._enabled||!e)return this;if(this._audio[e])if(t)this._audio[e].currentTime=0,this._audio[e].playPromise=this._audio[e].play();else{var r=this._audio[e];void 0!==r.playPromise&&r.playPromise.then(function(){r.pause()})}else t&&(this._audio[e]=new Audio,this._audio[e].src=e,this._audio[e].loop=!0,this._audio[e].volume=n,this._audio[e].playPromise=this._audio[e].play());return this},i.prototype.loadAudio=function(e){this._incoming=e.incoming,this._outgoing=e.outgoing,this._audio={}},i.prototype.setVolume=function(e){for(var t in e<0&&(e=0),1<e&&(e=1),this.volume=e,this._audio)this._audio.hasOwnProperty(t)&&(this._audio[t].volume=e)},i.prototype.playIncoming=function(e){return this._playSound(this._incoming,e,this.volume||.5)},i.prototype.playOutgoing=function(e){return this._playSound(this._outgoing,e,this.volume||1)},i);function i(e){void 0===e&&(e={}),this._enabled=!!e.enabled,this.loadAudio(e)}t.AudioHelper=r},function(e,t,n){"use strict";var s=this&&this.__awaiter||function(e,s,a,c){return new(a=a||Promise)(function(t,n){function r(e){try{o(c.next(e))}catch(e){n(e)}}function i(e){try{o(c.throw(e))}catch(e){n(e)}}function o(e){e.done?t(e.value):function(t){return t instanceof a?t:new a(function(e){e(t)})}(e.value).then(r,i)}o((c=c.apply(e,s||[])).next())})},a=this&&this.__generator||function(n,r){var i,o,s,e,a={label:0,sent:function(){if(1&s[0])throw s[1];return s[1]},trys:[],ops:[]};return e={next:t(0),throw:t(1),return:t(2)},"function"==typeof Symbol&&(e[Symbol.iterator]=function(){return this}),e;function t(t){return function(e){return function(t){if(i)throw new TypeError("Generator is already executing.");for(;a;)try{if(i=1,o&&(s=2&t[0]?o.return:t[0]?o.throw||((s=o.return)&&s.call(o),0):o.next)&&!(s=s.call(o,t[1])).done)return s;switch(o=0,s&&(t=[2&t[0],s.value]),t[0]){case 0:case 1:s=t;break;case 4:return a.label++,{value:t[1],done:!1};case 5:a.label++,o=t[1],t=[0];continue;case 7:t=a.ops.pop(),a.trys.pop();continue;default:if(!(s=0<(s=a.trys).length&&s[s.length-1])&&(6===t[0]||2===t[0])){a=0;continue}if(3===t[0]&&(!s||t[1]>s[0]&&t[1]<s[3])){a.label=t[1];break}if(6===t[0]&&a.label<s[1]){a.label=s[1],s=t;break}if(s&&a.label<s[2]){a.label=s[2],a.ops.push(t);break}s[2]&&a.ops.pop(),a.trys.pop();continue}t=r.call(n,a)}catch(e){t=[6,e],o=0}finally{i=s=0}if(5&t[0])throw t[1];return{value:t[0]?t[1]:void 0,done:!0}}([t,e])}}},o=this&&this.__spreadArrays||function(){for(var e=0,t=0,n=arguments.length;t<n;t++)e+=arguments[t].length;var r=Array(e),i=0;for(t=0;t<n;t++)for(var o=arguments[t],s=0,a=o.length;s<a;s++,i++)r[i]=o[s];return r};Object.defineProperty(t,"__esModule",{value:!0}),t.patchIncomingSession=t.patchSession=void 0;var l=n(0),p=n(1),r=n(10),h=n(2),c=n(3),u=n(12);t.patchSession=function(n){if(n.__patched)return n;n.__patched=!0,n.__sendRequest=n.sendRequest,n.__receiveRequest=n.receiveRequest,n.__accept=n.accept,n.__hold=n.hold,n.__unhold=n.unhold,n.__dtmf=n.dtmf,n.__reinvite=n.reinvite,n.sendRequest=function(e,t){return e!==l.C.PRACK?this.__sendRequest(e,t):this}.bind(n),n.receiveRequest=function(e){var t,n,r;switch(e.method){case l.C.INFO:var i=this.getIncomingInfoContent(e);if((null===(t=null==i?void 0:i.request)||void 0===t?void 0:t.reqId)&&"move"===(null===(n=null==i?void 0:i.request)||void 0===n?void 0:n.command)&&"rcv"===(null===(r=null==i?void 0:i.request)||void 0===r?void 0:r.target))return e.reply(200),this.emit("moveToRcv",i.request),this;if(this.emit("RC_SIP_INFO",e),this.status===l.Session.C.STATUS_CONFIRMED||this.status===l.Session.C.STATUS_WAITING_FOR_ACK)if(e.getHeader("content-type").match(/^application\/json/i))return e.reply(200),this}return this.__receiveRequest.apply(this,arguments)}.bind(n),n.accept=function(i){var o=this;void 0===i&&(i={});return(i=i||{}).extraHeaders=(i.extraHeaders||[]).concat(this.ua.defaultHeaders),i.RTCConstraints=i.RTCConstraints||{optional:[{DtlsSrtpKeyAgreement:"true"}]},new Promise(function(e,t){function n(){e(o),o.removeListener("failed",r)}var r=function(e){t(e),o.removeListener("accepted",n)};o.once("accepted",n),o.once("failed",r),o.__accept(i)})}.bind(n),n.hold=function(){return s(this,void 0,void 0,function(){var t,n;return a(this,function(e){switch(e.label){case 0:if(this.status!==l.Session.C.STATUS_WAITING_FOR_ACK&&this.status!==l.Session.C.STATUS_CONFIRMED)throw new l.Exceptions.InvalidStateError(this.status);if(this.localHold)throw new Error("Session already on hold");this.stopMediaStats(),(t={modifiers:[]}).modifiers.push(this.sessionDescriptionHandler.holdModifier),e.label=1;case 1:return e.trys.push([1,3,,4]),this.logger.log("Hold Initiated"),[4,this._sendReinvite(t)];case 2:return n=e.sent(),this.localHold=200===n.statusCode&&"sendonly"===this.sessionDescriptionHandler.getDirection(),this.logger.log("Hold completed, localhold is set to "+this.localHold),[3,4];case 3:throw e.sent(),new Error("Hold could not be completed");case 4:return[2]}})})}.bind(n),n.unhold=function(){return s(this,void 0,void 0,function(){var t;return a(this,function(e){switch(e.label){case 0:if(this.status!==l.Session.C.STATUS_WAITING_FOR_ACK&&this.status!==l.Session.C.STATUS_CONFIRMED)throw new l.Exceptions.InvalidStateError(this.status);if(!this.localHold)throw new Error("Session not on hold, cannot unhold");e.label=1;case 1:return e.trys.push([1,3,,4]),this.logger.log("Unhold Initiated"),[4,this._sendReinvite()];case 2:return t=e.sent(),this.localHold=200===t.statusCode&&"sendonly"===this.sessionDescriptionHandler.getDirection(),this.logger.log("Unhold completed, localhold is set to "+this.localHold),[3,4];case 3:throw e.sent(),new Error("Unhold could not be completed");case 4:return[2]}})})}.bind(n),n.dtmf=function(e,t,n){void 0===t&&(t=100);void 0===n&&(n=50);t=parseInt(t.toString()),n=parseInt(n.toString());var r=this.sessionDescriptionHandler.peerConnection.getSenders().find(function(e){return e.track&&"audio"===e.track.kind}).dtmf;if(void 0!==r&&r)return this.logger.log("Send DTMF: "+e+" Duration: "+t+" InterToneGap: "+n),r.insertDTMF(e,t,n);var i=r&&!r.canInsertDTMF?"can't insert DTMF":"Unknown";throw new Error("Send DTMF failed: "+(r?i:"no sender"))}.bind(n),n.reinvite=function(e,t){void 0===e&&(e={});void 0===t&&(t=null);return e.sessionDescriptionHandlerOptions=e.sessionDescriptionHandlerOptions||{},this.__reinvite(e,t)}.bind(n),n.warmTransfer=function(t,n){void 0===n&&(n={});return s(this,void 0,void 0,function(){return a(this,function(e){switch(e.label){case 0:return[4,this.localHold?Promise.resolve(null):this.hold()];case 1:return e.sent(),n.extraHeaders=(n.extraHeaders||[]).concat(this.ua.defaultHeaders),this.logger.log("Completing warm transfer"),[2,Promise.resolve(this.refer(t,n))]}})})}.bind(n),n.blindTransfer=function(e,t){void 0===t&&(t={});return this.logger.log("Call transfer initiated"),Promise.resolve(this.refer(e,t))}.bind(n),n.transfer=function(t,n){void 0===n&&(n={});return s(this,void 0,void 0,function(){return a(this,function(e){return n.extraHeaders=(n.extraHeaders||[]).concat(this.ua.defaultHeaders),[2,this.blindTransfer(t,n)]})})}.bind(n),n.park=function(){return y(this,p.messages.park)}.bind(n),n.forward=function(r,i,o){return s(this,void 0,void 0,function(){var t,n=this;return a(this,function(e){switch(e.label){case 0:return t=null,[4,this.accept(i)];case 1:return e.sent(),[2,new Promise(function(e){t=setInterval(function(){n.status===l.Session.C.STATUS_CONFIRMED&&(clearInterval(t),n.mute(),setTimeout(function(){e(n.transfer(r,o))},700))},50)})]}})})}.bind(n),n.startRecord=function(){return s(this,void 0,void 0,function(){return a(this,function(e){return[2,b(this,!0)]})})}.bind(n),n.stopRecord=function(){return s(this,void 0,void 0,function(){return a(this,function(e){return[2,b(this,!1)]})})}.bind(n),n.flip=function(t){return s(this,void 0,void 0,function(){return a(this,function(e){return[2,y(this,p.messages.flip,{target:t})]})})}.bind(n),n.mute=function(e){if(this.status!==l.Session.C.STATUS_CONFIRMED)return void this.logger.warn("An active call is required to mute audio");this.logger.log("Muting Audio"),e||this.emit("muted",this);return w(this,!0)}.bind(n),n.unmute=function(e){if(this.status!==l.Session.C.STATUS_CONFIRMED)return void this.logger.warn("An active call is required to unmute audio");this.logger.log("Unmuting Audio"),e||this.emit("unmuted",this);return w(this,!1)}.bind(n),n.onLocalHold=function(){return this.localHold}.bind(n),n.media=n.ua.media,n.addTrack=_.bind(n),n.stopMediaStats=function(){if(this.logger.log("Stopping media stats collection"),!this)return;this.mediaStreams&&this.mediaStreams.stopMediaStats(),this.mediaStatsStarted=!1,this.noAudioReportCount=0}.bind(n),n.getIncomingInfoContent=function(e){if(!e||!e.body)return{};var t={};try{t=JSON.parse(e.body)}catch(e){return{}}return t}.bind(n),n.sendMoveResponse=function(e,t,n,r){void 0===r&&(r={});var i=o(r.extraHeaders||[],this.ua.defaultHeaders,["Content-Type: application/json;charset=utf-8"]);this.sendRequest(l.C.INFO,{body:JSON.stringify({response:{reqId:e,command:"move",result:{code:t,description:n}}}),extraHeaders:i})}.bind(n),n._sendReinvite=function(o){void 0===o&&(o={});return s(this,void 0,void 0,function(){var n,t,r,i=this;return a(this,function(e){switch(e.label){case 0:if(this.pendingReinvite)throw new Error("Reinvite in progress. Please wait until complete, then try again.");if(!this.sessionDescriptionHandler)throw new Error("No SessionDescriptionHandler, can't send reinvite..");this.pendingReinvite=!0,o.modifiers=o.modifiers||[],e.label=1;case 1:return e.trys.push([1,5,,6]),[4,this.sessionDescriptionHandler.getDescription(o.sessionDescriptionHandlerOptions,o.modifiers)];case 2:return n=e.sent(),[4,new Promise(function(t,e){i.sendRequest(l.C.INVITE,{body:n,receiveResponse:function(e){200===e.statusCode&&t(e)}})})];case 3:return t=e.sent(),[4,this.receiveReinviteResponse(t)];case 4:return e.sent(),[2,t];case 5:throw r=e.sent(),this.pendingReinvite=!1,new Error("Reinvite Failed with the reason "+r.message);case 6:return[2]}})})}.bind(n),n.on("replaced",t.patchSession),n.on("progress",function(t){e(),183===t.statusCode&&(n.logger.log("Receiving 183 In Progress from server"),n.createDialog(t,"UAC"),n.hasAnswer=!0,n.status=l.Session.C.STATUS_EARLY_MEDIA,n.logger.log("Created UAC Dialog"),n.sessionDescriptionHandler.setDescription(t.body).catch(function(e){n.logger.warn(e),n.failed(t,l.C.causes.BAD_MEDIA_DESCRIPTION),n.terminate({status_code:488,reason_phrase:"Bad Media Description"}),n.logger.log("Call failed with Bad Media Description")}))}),n.media&&n.on("trackAdded",_);var e=function(){n.ua.audioHelper.playOutgoing(!1),n.ua.audioHelper.playIncoming(!1),n.removeListener("accepted",e),n.removeListener("rejected",e),n.removeListener("bye",e),n.removeListener("terminated",e),n.removeListener("cancel",e),n.removeListener("failed",e),n.removeListener("replaced",e)};return n.on("accepted",e),n.on("rejected",e),n.on("bye",e),n.on("terminated",e),n.on("cancel",e),n.on("failed",e),n.on("replaced",e),n.ua.enableQos&&n.on("SessionDescriptionHandler-created",function(){n.logger.log("SessionDescriptionHandler Created"),r.startQosStatsCollection(n),navigator.mediaDevices.enumerateDevices().then(function(e){e.forEach(function(e){n.logger.log(e.kind+" = "+e.label+JSON.stringify(e))})})}),n.ua.onSession&&n.ua.onSession(n),n.mediaStatsStarted=!1,n.noAudioReportCount=0,n.reinviteForNoAudioSent=!1,n},t.patchIncomingSession=function(t){try{i(t)}catch(e){t.logger.error("Can't parse RC headers from invite request due to "+e)}t.canUseRCMCallControl=f,t.createSessionMessage=g,t.sendSessionMessage=v,t.sendReceiveConfirm=S,t.ignore=m,t.toVoicemail=C,t.replyWithMessage=T};var i=function(e){var t=e.request.headers["P-Rc"],n=e.request.headers["P-Rc-Api-Call-Info"];if(t&&t.length){var r=t[0].raw,i=(new DOMParser).parseFromString(r,"text/xml"),o=i.getElementsByTagName("Hdr")[0],s=i.getElementsByTagName("Bdy")[0];o&&(e.rcHeaders={sid:o.getAttribute("SID"),request:o.getAttribute("Req"),from:o.getAttribute("From"),to:o.getAttribute("To")}),s&&h.extend(e.rcHeaders,{srvLvl:s.getAttribute("SrvLvl"),srvLvlExt:s.getAttribute("SrvLvlExt"),nm:s.getAttribute("Nm"),toNm:s.getAttribute("ToNm")})}if(n&&n.length){var a=n[0].raw;if(a){var c=function(e){void 0===e&&(e="");var i={};return e.split(/; */).forEach(function(e){var t=e.indexOf("=");if(!(t<0)){var n=e.substr(0,t).trim(),r=e.substr(++t,e.length).trim();void 0===i[n]&&(i[n]=r)}}),i}(a);h.extend(e.rcHeaders,c)}}},d=2e3;function f(){return!!this.rcHeaders}function g(e){if(this.rcHeaders)return h.extend(e,{sid:this.rcHeaders.sid,request:this.rcHeaders.request,from:this.rcHeaders.to,to:this.rcHeaders.from}),this.ua.createRcMessage(e)}function m(){return s(this,void 0,void 0,function(){var t=this;return a(this,function(e){return[2,this._sendReceiveConfirmPromise.then(function(){return t.sendSessionMessage(p.messages.ignore)})]})})}function v(t){return s(this,void 0,void 0,function(){return a(this,function(e){if(!this.rcHeaders)throw new Error("Can't send SIP MESSAGE related to session: no RC headers available");return[2,this.ua.sendMessage(this.rcHeaders.from,this.createSessionMessage(t))]})})}function S(){return s(this,void 0,void 0,function(){return a(this,function(e){return[2,this.sendSessionMessage(p.messages.receiveConfirm)]})})}function C(){return s(this,void 0,void 0,function(){var t=this;return a(this,function(e){return[2,this._sendReceiveConfirmPromise.then(function(){return t.sendSessionMessage(p.messages.toVoicemail)})]})})}function T(r){return s(this,void 0,void 0,function(){var t,n=this;return a(this,function(e){return t='RepTp="'+r.replyType+'"',0===r.replyType?t+=' Bdy="'+r.replyText+'"':1!==r.replyType&&4!==r.replyType||(t+=' Vl="'+r.timeValue+'"',t+=' Units="'+r.timeUnits+'"',t+=' Dir="'+r.callbackDirection+'"'),[2,this._sendReceiveConfirmPromise.then(function(){return n.sendSessionMessage({reqid:p.messages.replyWithMessage.reqid,body:t})})]})})}function y(u,d,t){return s(this,void 0,void 0,function(){var c;return a(this,function(e){return t=t||{},h.extend(d,t),[2,new Promise(function(s,a){var e=(t.extraHeaders||[]).concat(u.ua.defaultHeaders).concat(["Content-Type: application/json;charset=utf-8"]);u.sendRequest(l.C.INFO,{body:JSON.stringify({request:d}),extraHeaders:e,receiveResponse:function(r){var i=null;if(200===r.statusCode){c=r.cseq;var o=function(e){if(r.cseq===c){var t,n=e&&e.body||"{}";try{t=JSON.parse(n)}catch(e){t={}}if(t.response&&t.response.command===d.command&&t.response.result)return"0"===t.response.result.code.toString()?s(t.response.result):a(t.response.result);i&&clearTimeout(i),u.removeListener("RC_SIP_INFO",o),s(null)}};i=setTimeout(function(){a(new Error("Timeout: no reply")),u.removeListener("RC_SIP_INFO",o)},p.responseTimeout),u.on("RC_SIP_INFO",o)}else a(new Error("The INFO response status code is: "+r.statusCode+" (waiting for 200)"))}})})]})})}function b(r,i){return s(this,void 0,void 0,function(){var t,n;return a(this,function(e){switch(e.label){case 0:return t=i?p.messages.startRecord:p.messages.stopRecord,r.__onRecord&&!i||!r.__onRecord&&i?[4,y(r,t)]:[3,2];case 1:return n=e.sent(),r.__onRecord=!!i,[2,n];case 2:return[2]}})})}function w(e,t){var n=e.sessionDescriptionHandler.peerConnection;n.getSenders&&n.getSenders().forEach(function(e){e.track&&(e.track.enabled=!t)})}function _(e,t){var n,r,i=this,o=this.sessionDescriptionHandler.peerConnection;if(e&&t)n=e,r=t;else{if(!this.media)throw new Error("HTML Media Element not Defined");n=this.media.remote,r=this.media.local}var s=new MediaStream;o.getReceivers?o.getReceivers().forEach(function(e){var t=e.track;t&&(s.addTrack(t),i.logger.log("Remote track added"))}):(s=o.getRemoteStreams()[0],this.logger.log("Remote track added")),n.srcObject=s,n.play().catch(function(){i.logger.log("Remote play was rejected")});var a=new MediaStream;o.getSenders?o.getSenders().forEach(function(e){var t=e.track;t&&"audio"===t.kind&&(a.addTrack(t),i.logger.log("Local track added"))}):(a=o.getLocalStreams()[0],this.logger.log("Local track added")),r.srcObject=a,r.play().catch(function(){i.logger.log("Local play was rejected")}),a&&s&&!this.mediaStatsStarted&&(this.mediaStreams=new c.MediaStreams(this),this.logger.log("Start gathering media report"),this.mediaStatsStarted=!0,this.mediaStreams.getMediaStats(function(e){i.ua.enableMediaReportLogging&&i.logger.log("Got media report: "+JSON.stringify(e)),!i.reinviteForNoAudioSent&&u.isNoAudio(e)?(i.logger.log("No audio report"),i.noAudioReportCount++,3===i.noAudioReportCount&&(i.logger.log("No audio for 6 sec. Trying to recover audio by sending Re-invite"),i.mediaStreams.reconnectMedia(),i.reinviteForNoAudioSent=!0,i.noAudioReportCount=0)):u.isNoAudio(e)||(i.noAudioReportCount=0)},d))}},function(e,t,n){"use strict";var r=this&&this.__assign||function(){return(r=Object.assign||function(e){for(var t,n=1,r=arguments.length;n<r;n++)for(var i in t=arguments[n])Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i]);return e}).apply(this,arguments)},i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.startQosStatsCollection=void 0;function a(e){return parseFloat(e.toString()).toFixed(2)}var o=i(n(11));t.startQosStatsCollection=function(n){var r,i=h();if(i.callID=n.request.callId||"",i.fromTag=n.request.fromTag||"",i.toTag=n.request.toTag||"",i.localID=n.request.headers.From[0].raw||n.request.headers.From[0],i.remoteID=n.request.headers.To[0].raw||n.request.headers.To[0],i.origID=n.request.headers.From[0].raw||n.request.headers.From[0],!o.default)throw new Error("getStats module was not provided!");o.default(n.sessionDescriptionHandler.peerConnection,function(e){r=e,i.status=!0;var t=g(r.connectionType);i.localAddr=r.connectionType.local.ipAddress[0],i.remoteAddr=r.connectionType.remote.ipAddress[0],r.results.forEach(function(e){"localcandidate"===e.type&&(i.localcandidate=e),"remotecandidate"===e.type&&(i.remotecandidate=e),"ssrc"===e.type&&e.id.includes("send")&&n.ua.enableMediaReportLogging&&0===parseInt(e.audioInputLevel,10)&&(n.logger.log("AudioInputLevel is 0. The local track might be muted or could have potential one-way audio issue. Check Microphone Volume settings."),n.emit("no-input-volume")),"ssrc"===e.type&&e.id.includes("recv")&&(i.jitterBufferDiscardRate=e.googSecondaryDiscardedRate||0,i.packetLost=e.packetsLost,i.packetsReceived=e.packetsReceived,i.totalSumJitter+=parseFloat(e.googJitterBufferMs),i.totalIntervalCount+=1,i.JBM=Math.max(i.JBM,parseFloat(e.googJitterBufferMs)),i.netType=f(i.netType,t),n.ua.enableMediaReportLogging&&parseInt(e.audioOutputLevel,10)<=1&&(n.logger.log("Remote audioOutput level is 1. The remote track might be muted or could have potential one-way audio issue"),n.emit("no-output-volume")))})},n.ua.qosCollectInterval),n.on("terminated",function(){r&&r.nomore(),n.logger.log("Release media streams"),n.mediaStreams&&n.mediaStreams.release(),u(n,i)})};var s,c,u=function(e,t,n){void 0===n&&(n={}),n=n||{};var r=navigator.connection.effectiveType||"",i=d(t)||"",o=n.targetUrl||"rtcpxr@rtcpxr.ringcentral.com:5060",s=n.event||"vq-rtcpxr";n.expires=60,n.contentType="application/vq-rtcpxr",n.extraHeaders=(n.extraHeaders||[]).concat(e.ua.defaultHeaders),n.extraHeaders.push("p-rc-client-info:cpuRC=0:0;cpuOS=0:0;netType="+i+";ram=0:0;effectiveType="+r);var a=l(t),c=p(a),u=e.ua.publish(o,s,c,n);e.logger.log("Local Candidate: "+JSON.stringify(t.localcandidate)),e.logger.log("Remote Candidate: "+JSON.stringify(t.remotecandidate)),t.status=!1,u.close(),e.emit("qos-published",c)},d=function(e){for(var t=[],n=0,r=Object.entries(e.netType);n<r.length;n++){var i=r[n],o=i[0],s=i[1];t.push(o+":"+a(100*s/e.totalIntervalCount))}return t.join()},l=function(e){var t=100*e.packetLost/(e.packetsReceived+e.packetLost)||0,n=0<e.totalIntervalCount?e.totalSumJitter/e.totalIntervalCount:0;return r(r({},e),{NLR:a(t),JBN:a(n),JDR:a(e.jitterBufferDiscardRate),MOSLQ:0})},p=function(e){var t=e.NLR||0,n=e.JBM||0,r=e.JBN||0,i=e.JDR||0,o=e.MOSLQ||0,s=e.callID||"",a=e.fromTag||"",c=e.toTag||"",u=e.localID||"";return"VQSessionReport: CallTerm\r\nCallID: "+s+"\r\nLocalID: "+u+"\r\nRemoteID: "+(e.remoteID||"")+"\r\nOrigID: "+u+"\r\nLocalAddr: IP="+(e.localAddr||"")+" SSRC=0x00000000\r\nRemoteAddr: IP="+(e.remoteAddr||"")+" SSRC=0x00000000\r\nLocalMetrics:\r\nTimestamps: START=0 STOP=0\r\nSessionDesc: PT=0 PD=opus SR=0 FD=0 FPP=0 PPS=0 PLC=0 SSUP=on\r\nJitterBuffer: JBA=0 JBR=0 JBN="+r+" JBM="+n+" JBX=0\r\nPacketLoss: NLR="+t+" JDR="+i+"\r\nBurstGapLoss: BLD=0 BD=0 GLD=0 GD=0 GMIN=0\r\nDelay: RTD=0 ESD=0 SOWD=0 IAJ=0\r\nQualityEst: MOSLQ="+o+" MOSCQ=0.0\r\nDialogID: "+s+";to-tag="+c+";from-tag="+a},h=function(){return{localAddr:"",remoteAddr:"",callID:"",localID:"",remoteID:"",origID:"",fromTag:"",toTag:"",timestamp:{start:"",stop:""},netType:{},packetLost:0,packetsReceived:0,jitterBufferNominal:0,jitterBufferMax:0,jitterBufferDiscardRate:0,totalSumJitter:0,totalIntervalCount:0,NLR:"",JBM:0,JBN:"",JDR:"",MOSLQ:0,status:!1,localcandidate:{},remotecandidate:{}}},f=function(e,t){var n;return void 0===e&&(e={}),r(r({},e),((n={})[t]=(t in e?parseInt(e[t]):0)+1,n))};(c=s=s||{}).bluetooth="Bluetooth",c.cellular="Cellulars",c.ethernet="Ethernet",c.wifi="WiFi",c.vpn="VPN",c.wimax="WiMax",c["2g"]="2G",c["3g"]="3G",c["4g"]="4G";var g=function(e){var t=e.systemNetworkType||"unknown",n=e.local.networkType||["unknown"],r=t&&"unknown"!==t?t:n[0];return r in s?s[r]:r}},function(e,t){e.exports=r},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.isNoAudio=void 0,t.isNoAudio=function(e){return!e.inboundRtpReport||(!e.outboundRtpReport||(0===e.inboundRtpReport.packetsReceived||0===e.outboundRtpReport.packetsSent))}},function(e,t,n){"use strict";var o=this&&this.__awaiter||function(e,s,a,c){return new(a=a||Promise)(function(t,n){function r(e){try{o(c.next(e))}catch(e){n(e)}}function i(e){try{o(c.throw(e))}catch(e){n(e)}}function o(e){e.done?t(e.value):function(t){return t instanceof a?t:new a(function(e){e(t)})}(e.value).then(r,i)}o((c=c.apply(e,s||[])).next())})},s=this&&this.__generator||function(n,r){var i,o,s,e,a={label:0,sent:function(){if(1&s[0])throw s[1];return s[1]},trys:[],ops:[]};return e={next:t(0),throw:t(1),return:t(2)},"function"==typeof Symbol&&(e[Symbol.iterator]=function(){return this}),e;function t(t){return function(e){return function(t){if(i)throw new TypeError("Generator is already executing.");for(;a;)try{if(i=1,o&&(s=2&t[0]?o.return:t[0]?o.throw||((s=o.return)&&s.call(o),0):o.next)&&!(s=s.call(o,t[1])).done)return s;switch(o=0,s&&(t=[2&t[0],s.value]),t[0]){case 0:case 1:s=t;break;case 4:return a.label++,{value:t[1],done:!1};case 5:a.label++,o=t[1],t=[0];continue;case 7:t=a.ops.pop(),a.trys.pop();continue;default:if(!(s=0<(s=a.trys).length&&s[s.length-1])&&(6===t[0]||2===t[0])){a=0;continue}if(3===t[0]&&(!s||t[1]>s[0]&&t[1]<s[3])){a.label=t[1];break}if(6===t[0]&&a.label<s[1]){a.label=s[1],s=t;break}if(s&&a.label<s[2]){a.label=s[2],a.ops.push(t);break}s[2]&&a.ops.pop(),a.trys.pop();continue}t=r.call(n,a)}catch(e){t=[6,e],o=0}finally{i=s=0}if(5&t[0])throw t[1];return{value:t[0]?t[1]:void 0,done:!0}}([t,e])}}};Object.defineProperty(t,"__esModule",{value:!0}),t.TransportConstructorWrapper=void 0,t.TransportConstructorWrapper=function(r,i){return function(e,t){var n=new r(e,t);return n.nextReconnectInterval=0,n.sipErrorCodes=i.sipErrorCodes,n.switchBackInterval=i.switchBackInterval,n.mainProxy=n.configuration.wsServers[0],n.computeRandomTimeout=c,n.reconnect=function(i){return o(this,void 0,void 0,function(){var t,n,r=this;return s(this,function(e){switch(e.label){case 0:return 0<this.reconnectionAttempts&&this.logger.warn("Reconnection attempt "+this.reconnectionAttempts+" failed"),i?(this.logger.warn("forcing connect to main WS server"),[4,this.disconnect({force:!0})]):[3,3];case 1:return e.sent(),this.server=this.getNextWsServer(!0),this.reconnectionAttempts=0,[4,this.connect()];case 2:return e.sent(),[2];case 3:return this.noAvailableServers()?(this.logger.warn("no available ws servers left - going to closed state"),this.status=a.STATUS_CLOSED,this.emit("closed"),this.resetServerErrorStatus(),this.server=this.getNextWsServer(!0),this.__clearSwitchBackTimer(),[2]):this.isConnected()?(this.logger.warn("attempted to reconnect while connected - forcing disconnect"),[4,this.disconnect({force:!0})]):[3,6];case 4:return e.sent(),[4,this.reconnect()];case 5:return e.sent(),[2];case 6:return t=1e3*(this.configuration.reconnectionTimeout-2),n=1e3*(this.configuration.reconnectionTimeout+2),this.reconnectionAttempts+=1,this.nextReconnectInterval=this.computeRandomTimeout(this.reconnectionAttempts,t,n),this.reconnectionAttempts>this.configuration.maxReconnectionAttempts?(this.logger.warn("maximum reconnection attempts for WebSocket "+this.server.wsUri),this.logger.warn("transport "+this.server.wsUri+" failed | connection state set to 'error'"),this.server.isError=!0,this.emit("transportError"),this.server=this.getNextWsServer(),this.reconnectionAttempts=0,[4,this.reconnect()]):[3,8];case 7:return e.sent(),[3,9];case 8:this.logger.warn("trying to reconnect to WebSocket "+this.server.wsUri+" (reconnection attempt "+this.reconnectionAttempts+")"),this.reconnectTimer=setTimeout(function(){r.connect(),r.reconnectTimer=void 0},this.nextReconnectInterval),this.logger.warn("next reconnection attempt in:"+Math.round(this.nextReconnectInterval/1e3)+" seconds."),e.label=9;case 9:return[2]}})})}.bind(n),n.isSipErrorCode=function(e){var t=e.substring(0,e.indexOf("\r\n")).split(" ")[1];return t&&this.sipErrorCodes&&this.sipErrorCodes.length&&this.sipErrorCodes.includes(t)}.bind(n),n.scheduleSwitchBackMainProxy=function(){var e=this,t=this.switchBackInterval?1e3*this.switchBackInterval:null;t?(t+=this.computeRandomTimeout(1,0,9e5),this.logger.warn("Try to switch back to main proxy after "+Math.round(t/1e3/60)+" min"),this.mainProxy.switchBackTimer=setTimeout(function(){e.mainProxy.isError=!1,e.mainProxy.switchBackTimer=null,e.logger.warn("switchBack initiated"),e.emit("switchBackProxy")},t)):this.logger.warn("switchBackInterval is not set. Will be switched with next provision update ")}.bind(n),n.onSipErrorCode=function(){return o(this,void 0,void 0,function(){return s(this,function(e){switch(e.label){case 0:return this.logger.warn("Error received from the server. Disconnecting from the proxy"),this.server.isError=!0,this.emit("transportError"),[4,this.disconnect({force:!0})];case 1:return e.sent(),this.server=this.getNextWsServer(),this.reconnectionAttempts=0,[2,this.reconnect()]}})})}.bind(n),n.__isCurrentMainProxy=function(){return this.server===this.configuration.wsServers[0]}.bind(n),n.__afterWSConnected=function(){this.__isCurrentMainProxy()?this.__onConnectedToMain():this.__onConnectedToBackup()}.bind(n),n.__onConnectedToBackup=function(){this.mainProxy.switchBackTimer||this.scheduleSwitchBackMainProxy()}.bind(n),n.__onConnectedToMain=function(){this.__clearSwitchBackTimer()}.bind(n),n.__clearSwitchBackTimer=function(){this.mainProxy.switchBackTimer&&(clearTimeout(this.mainProxy.switchBackTimer),this.mainProxy.switchBackTimer=null)}.bind(n),n.__connect=n.connect,n.connect=function(t){return o(this,void 0,void 0,function(){var n=this;return s(this,function(e){switch(e.label){case 0:return[4,this.__connect(t).catch(function(t){return o(n,void 0,void 0,function(){return s(this,function(e){switch(e.label){case 0:return this.emit("wsConnectionError",t),this.logger.warn("Connection Error occured. Trying to reconnect to websocket..."),this.onError(t),this.disconnect({force:!0}),this.disposeWs(),[4,this.reconnect()];case 1:return e.sent(),[2]}})})})];case 1:return[2,e.sent()]}})})}.bind(n),n.on("connected",n.__afterWSConnected),n}};var a={STATUS_CONNECTING:0,STATUS_OPEN:1,STATUS_CLOSING:2,STATUS_CLOSED:3},c=function(e,t,n){if(void 0===e&&(e=1),void 0===t&&(t=0),void 0===n&&(n=0),t<0||n<0||e<1)throw new Error("Arguments must be positive numbers");return Math.floor(Math.random()*Math.abs(n-t))+t+(e-1)*(t+n)/2}},function(e,f,g){"use strict";(function(o){var r,e=this&&this.__extends||(r=function(e,t){return(r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])})(e,t)},function(e,t){function n(){this.constructor=e}r(e,t),e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)}),i=this&&this.__createBinding||(Object.create?function(e,t,n,r){void 0===r&&(r=n),Object.defineProperty(e,r,{enumerable:!0,get:function(){return t[n]}})}:function(e,t,n,r){void 0===r&&(r=n),e[r]=t[n]}),s=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),t=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)Object.hasOwnProperty.call(e,n)&&i(t,e,n);return s(t,e),t};Object.defineProperty(f,"__esModule",{value:!0}),f.DefaultSessionDescriptionHandler=void 0;var a,n=g(16),c=g(4),u=g(0),d=g(5),l=t(g(17)),p=(a=n.EventEmitter,e(h,a),h.defaultFactory=function(e,t){return new h(e.ua.getLogger("sip.invitecontext.sessionDescriptionHandler",e.id),new d.SessionDescriptionHandlerObserver(e,t),t)},h.prototype.close=function(){this.logger.log("closing PeerConnection"),this.peerConnection&&"closed"!==this.peerConnection.signalingState&&(this.peerConnection.getSenders?this.peerConnection.getSenders().forEach(function(e){e.track&&e.track.stop()}):(this.logger.warn("Using getLocalStreams which is deprecated"),this.peerConnection.getLocalStreams().forEach(function(e){e.getTracks().forEach(function(e){e.stop()})})),this.peerConnection.getReceivers?this.peerConnection.getReceivers().forEach(function(e){e.track&&e.track.stop()}):(this.logger.warn("Using getRemoteStreams which is deprecated"),this.peerConnection.getRemoteStreams().forEach(function(e){e.getTracks().forEach(function(e){e.stop()})})),this.resetIceGatheringComplete(),this.peerConnection.close())},h.prototype.getDescription=function(e,t){var n=this;void 0===e&&(e={}),void 0===t&&(t=[]),e.peerConnectionOptions&&this.initPeerConnection(e.peerConnectionOptions);var r=Object.assign({},this.constraints,e.constraints);return r=this.checkAndDefaultConstraints(r),JSON.stringify(r)!==JSON.stringify(this.constraints)&&(this.constraints=r,this.shouldAcquireMedia=!0),Array.isArray(t)||(t=[t]),t=t.concat(this.modifiers),Promise.resolve().then(function(){if(n.shouldAcquireMedia)return n.acquire(n.constraints).then(function(){n.shouldAcquireMedia=!1})}).then(function(){return n.createOfferOrAnswer(e.RTCOfferOptions,t)}).then(function(e){return n.emit("getDescription",e),{body:e.sdp,contentType:n.CONTENT_TYPE}})},h.prototype.hasDescription=function(e){return e===this.CONTENT_TYPE},h.prototype.holdModifier=function(e){return e.sdp&&(/a=(sendrecv|sendonly|recvonly|inactive)/.test(e.sdp)?(e.sdp=e.sdp.replace(/a=sendrecv\r\n/g,"a=sendonly\r\n"),e.sdp=e.sdp.replace(/a=recvonly\r\n/g,"a=inactive\r\n")):e.sdp=e.sdp.replace(/(m=[^\r]*\r\n)/g,"$1a=sendonly\r\n")),Promise.resolve(e)},h.prototype.setDescription=function(n,r,i){var o=this;void 0===r&&(r={}),void 0===i&&(i=[]),r.peerConnectionOptions&&this.initPeerConnection(r.peerConnectionOptions),Array.isArray(i)||(i=[i]),i=i.concat(this.modifiers);var e={type:this.hasOffer("local")?"answer":"offer",sdp:n};return Promise.resolve().then(function(){if(o.shouldAcquireMedia&&o.options.alwaysAcquireMediaFirst)return o.acquire(o.constraints).then(function(){o.shouldAcquireMedia=!1})}).then(function(){return u.Utils.reducePromises(i,e)}).catch(function(e){if(e.type===c.TypeStrings.SessionDescriptionHandlerError)throw e;var t=new u.Exceptions.SessionDescriptionHandlerError("setDescription",e,"The modifiers did not resolve successfully");throw o.logger.error(t.message),o.emit("peerConnection-setRemoteDescriptionFailed",t),t}).then(function(e){return o.emit("setDescription",e),o.peerConnection.setRemoteDescription(e)}).catch(function(e){if(e.type===c.TypeStrings.SessionDescriptionHandlerError)throw e;if(/^m=video.+$/gm.test(n)&&!r.disableAudioFallback)return r.disableAudioFallback=!0,o.setDescription(n,r,[l.stripVideo].concat(i));var t=new u.Exceptions.SessionDescriptionHandlerError("setDescription",e);throw t.error&&o.logger.error(t.error),o.emit("peerConnection-setRemoteDescriptionFailed",t),t}).then(function(){o.peerConnection.getReceivers?o.emit("setRemoteDescription",o.peerConnection.getReceivers()):o.emit("setRemoteDescription",o.peerConnection.getRemoteStreams()),o.emit("confirmed",o)})},h.prototype.sendDtmf=function(e,t){if(void 0===t&&(t={}),!this.dtmfSender&&this.hasBrowserGetSenderSupport()){var n=this.peerConnection.getSenders();0<n.length&&(this.dtmfSender=n[0].dtmf)}if(!this.dtmfSender&&this.hasBrowserTrackSupport()){var r=this.peerConnection.getLocalStreams();if(0<r.length){var i=r[0].getAudioTracks();0<i.length&&(this.dtmfSender=this.peerConnection.createDTMFSender(i[0]))}}if(!this.dtmfSender)return!1;try{this.dtmfSender.insertDTMF(e,t.duration,t.interToneGap)}catch(e){if("InvalidStateError"===e.type||"InvalidCharacterError"===e.type)return this.logger.error(e),!1;throw e}return this.logger.log("DTMF sent via RTP: "+e.toString()),!0},h.prototype.getDirection=function(){return this.direction},h.prototype.createOfferOrAnswer=function(e,t){var n=this;void 0===e&&(e={}),void 0===t&&(t=[]);var r=this.hasOffer("remote")?"createAnswer":"createOffer",i=this.peerConnection;return this.logger.log(r),i[r](e).catch(function(e){if(e.type===c.TypeStrings.SessionDescriptionHandlerError)throw e;var t=new u.Exceptions.SessionDescriptionHandlerError("createOfferOrAnswer",e,"peerConnection-"+r+"Failed");throw n.emit("peerConnection-"+r+"Failed",t),t}).then(function(e){return u.Utils.reducePromises(t,n.createRTCSessionDescriptionInit(e))}).then(function(e){return n.resetIceGatheringComplete(),n.logger.log("Setting local sdp."),n.logger.log("sdp is "+e.sdp||!1),i.setLocalDescription(e)}).catch(function(e){if(e.type===c.TypeStrings.SessionDescriptionHandlerError)throw e;var t=new u.Exceptions.SessionDescriptionHandlerError("createOfferOrAnswer",e,"peerConnection-SetLocalDescriptionFailed");throw n.emit("peerConnection-SetLocalDescriptionFailed",t),t}).then(function(){return n.waitForIceGatheringComplete()}).then(function(){var e=n.createRTCSessionDescriptionInit(n.peerConnection.localDescription);return u.Utils.reducePromises(t,e)}).then(function(e){return n.setDirection(e.sdp||""),e}).catch(function(e){if(e.type===c.TypeStrings.SessionDescriptionHandlerError)throw e;var t=new u.Exceptions.SessionDescriptionHandlerError("createOfferOrAnswer",e);throw n.logger.error(t.toString()),t})},h.prototype.createRTCSessionDescriptionInit=function(e){return{type:e.type,sdp:e.sdp}},h.prototype.addDefaultIceCheckingTimeout=function(e){return void 0===e.iceCheckingTimeout&&(e.iceCheckingTimeout=5e3),e},h.prototype.addDefaultIceServers=function(e){return e.iceServers||(e.iceServers=[{urls:"stun:stun.l.google.com:19302"}]),e},h.prototype.checkAndDefaultConstraints=function(e){var t={audio:!0,video:!this.options.alwaysAcquireMediaFirst};return e=e||t,0===Object.keys(e).length&&e.constructor===Object?t:e},h.prototype.hasBrowserTrackSupport=function(){return Boolean(this.peerConnection.addTrack)},h.prototype.hasBrowserGetSenderSupport=function(){return Boolean(this.peerConnection.getSenders)},h.prototype.initPeerConnection=function(e){var t=this;void 0===e&&(e={}),(e=this.addDefaultIceCheckingTimeout(e)).rtcConfiguration=e.rtcConfiguration||{},e.rtcConfiguration=this.addDefaultIceServers(e.rtcConfiguration),this.logger.log("initPeerConnection"),this.peerConnection&&(this.logger.log("Already have a peer connection for this session. Tearing down."),this.resetIceGatheringComplete(),this.peerConnection.close()),console.error("RTCConfiguration: ",e.rtcConfiguration),this.peerConnection=new this.WebRTC.RTCPeerConnection(e.rtcConfiguration,{optional:[{googDscp:!0}]}),this.logger.log("New peer connection created"),console.error("newPeerconnection",this.peerConnection),"ontrack"in this.peerConnection?this.peerConnection.addEventListener("track",function(e){t.logger.log("track added"),t.observer.trackAdded(),t.emit("addTrack",e)}):(this.logger.warn("Using onaddstream which is deprecated"),this.peerConnection.onaddstream=function(e){t.logger.log("stream added"),t.emit("addStream",e)}),this.peerConnection.onicecandidate=function(e){t.emit("iceCandidate",e),e.candidate?t.logger.log("ICE candidate received: "+(null===e.candidate.candidate?null:e.candidate.candidate.trim())):null===e.candidate&&(t.logger.log("ICE candidate gathering complete"),t.triggerIceGatheringComplete())},this.peerConnection.onicegatheringstatechange=function(){switch(t.logger.log("RTCIceGatheringState changed: "+t.peerConnection.iceGatheringState),t.peerConnection.iceGatheringState){case"gathering":t.emit("iceGathering",t),!t.iceGatheringTimer&&e.iceCheckingTimeout&&(t.iceGatheringTimeout=!1,t.iceGatheringTimer=setTimeout(function(){t.logger.log("RTCIceChecking Timeout Triggered after "+e.iceCheckingTimeout+" milliseconds"),t.iceGatheringTimeout=!0,t.triggerIceGatheringComplete()},e.iceCheckingTimeout));break;case"complete":t.triggerIceGatheringComplete()}},this.peerConnection.oniceconnectionstatechange=function(){var e;switch(t.peerConnection.iceConnectionState){case"new":e="iceConnection";break;case"checking":e="iceConnectionChecking";break;case"connected":e="iceConnectionConnected";break;case"completed":e="iceConnectionCompleted";break;case"failed":e="iceConnectionFailed";break;case"disconnected":e="iceConnectionDisconnected";break;case"closed":e="iceConnectionClosed";break;default:return void t.logger.warn("Unknown iceConnection state: "+t.peerConnection.iceConnectionState)}t.logger.log("ICE Connection State changed to "+e),t.emit(e,t)}},h.prototype.acquire=function(e){var r=this;return e=this.checkAndDefaultConstraints(e),new Promise(function(t,n){r.logger.log("acquiring local media"),r.emit("userMediaRequest",e),e.audio||e.video?r.WebRTC.getUserMedia(e).then(function(e){r.observer.trackAdded(),r.emit("userMedia",e),t(e)}).catch(function(e){r.emit("userMediaFailed",e),n(e)}):t([])}).catch(function(e){if(e.type===c.TypeStrings.SessionDescriptionHandlerError)throw e;var t=new u.Exceptions.SessionDescriptionHandlerError("acquire",e,"unable to acquire streams");throw r.logger.error(t.message),t.error&&r.logger.error(t.error),t}).then(function(e){r.logger.log("acquired local media streams");try{return r.peerConnection.removeTrack&&r.peerConnection.getSenders().forEach(function(e){r.peerConnection.removeTrack(e)}),e}catch(e){return Promise.reject(e)}}).catch(function(e){if(e.type===c.TypeStrings.SessionDescriptionHandlerError)throw e;var t=new u.Exceptions.SessionDescriptionHandlerError("acquire",e,"error removing streams");throw r.logger.error(t.message),t.error&&r.logger.error(t.error),t}).then(function(e){try{(e=[].concat(e)).forEach(function(t){r.peerConnection.addTrack?t.getTracks().forEach(function(e){r.peerConnection.addTrack(e,t)}):r.peerConnection.addStream(t)}),r.peerConnection.getSenders().filter(function(e){return e.track}).forEach(function(t){var e=t.getParameters();console.error("getsender params =",e),e.priority="high",t.setParameters(e).catch(function(e){console.error("Error while setting encodings parameters for "+t.track.kind+" Track "+t.track.id+": "+(e.message||e.name))})})}catch(e){return Promise.reject(e)}return Promise.resolve()}).catch(function(e){if(e.type===c.TypeStrings.SessionDescriptionHandlerError)throw e;var t=new u.Exceptions.SessionDescriptionHandlerError("acquire",e,"error adding stream");throw r.logger.error(t.message),t.error&&r.logger.error(t.error),t})},h.prototype.hasOffer=function(e){var t="have-"+e+"-offer";return this.peerConnection.signalingState===t},h.prototype.isIceGatheringComplete=function(){return"complete"===this.peerConnection.iceGatheringState||this.iceGatheringTimeout},h.prototype.resetIceGatheringComplete=function(){this.iceGatheringTimeout=!1,this.logger.log("resetIceGatheringComplete"),this.iceGatheringTimer&&(clearTimeout(this.iceGatheringTimer),this.iceGatheringTimer=void 0),this.iceGatheringDeferred&&(this.iceGatheringDeferred.reject(),this.iceGatheringDeferred=void 0)},h.prototype.setDirection=function(e){var t=e.match(/a=(sendrecv|sendonly|recvonly|inactive)/);if(null===t)return this.direction=this.C.DIRECTION.NULL,void this.observer.directionChanged();var n=t[1];switch(n){case this.C.DIRECTION.SENDRECV:case this.C.DIRECTION.SENDONLY:case this.C.DIRECTION.RECVONLY:case this.C.DIRECTION.INACTIVE:this.direction=n;break;default:this.direction=this.C.DIRECTION.NULL}this.observer.directionChanged()},h.prototype.triggerIceGatheringComplete=function(){this.isIceGatheringComplete()&&(this.emit("iceGatheringComplete",this),this.iceGatheringTimer&&(clearTimeout(this.iceGatheringTimer),this.iceGatheringTimer=void 0),this.iceGatheringDeferred&&(this.iceGatheringDeferred.resolve(),this.iceGatheringDeferred=void 0))},h.prototype.waitForIceGatheringComplete=function(){return this.logger.log("waitForIceGatheringComplete"),this.isIceGatheringComplete()?(this.logger.log("ICE is already complete. Return resolved."),Promise.resolve()):(this.logger.log("ICE is not complete. Returning promise"),this.iceGatheringDeferred?this.iceGatheringDeferred.promise:Promise.resolve())},h);function h(e,t,n){var r=a.call(this)||this;r.type=c.TypeStrings.SessionDescriptionHandler,r.options=n||{},r.logger=e,r.observer=t,r.dtmfSender=void 0,r.shouldAcquireMedia=!0,r.CONTENT_TYPE="application/sdp",r.C={DIRECTION:{NULL:null,SENDRECV:"sendrecv",SENDONLY:"sendonly",RECVONLY:"recvonly",INACTIVE:"inactive"}},r.logger.log("SessionDescriptionHandlerOptions: "+JSON.stringify(r.options)),r.direction=r.C.DIRECTION.NULL,r.modifiers=r.options.modifiers||[],Array.isArray(r.modifiers)||(r.modifiers=[r.modifiers]);var i=o.window||o;return r.WebRTC={MediaStream:i.MediaStream,getUserMedia:i.navigator.mediaDevices.getUserMedia.bind(i.navigator.mediaDevices),RTCPeerConnection:i.RTCPeerConnection},r.iceGatheringTimeout=!1,r.initPeerConnection(r.options.peerConnectionOptions),r.constraints=r.checkAndDefaultConstraints(r.options.constraints),r}f.DefaultSessionDescriptionHandler=p}).call(this,g(15))},function(e,t){var n;n=function(){return this}();try{n=n||new Function("return this")()}catch(e){"object"==typeof window&&(n=window)}e.exports=n},function(e,t,n){"use strict";var r,i="object"==typeof Reflect?Reflect:null,d=i&&"function"==typeof i.apply?i.apply:function(e,t,n){return Function.prototype.apply.call(e,t,n)};r=i&&"function"==typeof i.ownKeys?i.ownKeys:Object.getOwnPropertySymbols?function(e){return Object.getOwnPropertyNames(e).concat(Object.getOwnPropertySymbols(e))}:function(e){return Object.getOwnPropertyNames(e)};var o=Number.isNaN||function(e){return e!=e};function s(){s.init.call(this)}((e.exports=s).EventEmitter=s).prototype._events=void 0,s.prototype._eventsCount=0,s.prototype._maxListeners=void 0;var a=10;function c(e){return void 0===e._maxListeners?s.defaultMaxListeners:e._maxListeners}function u(e,t,n,r){var i,o,s;if("function"!=typeof n)throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof n);if(void 0===(o=e._events)?(o=e._events=Object.create(null),e._eventsCount=0):(void 0!==o.newListener&&(e.emit("newListener",t,n.listener?n.listener:n),o=e._events),s=o[t]),void 0===s)s=o[t]=n,++e._eventsCount;else if("function"==typeof s?s=o[t]=r?[n,s]:[s,n]:r?s.unshift(n):s.push(n),0<(i=c(e))&&s.length>i&&!s.warned){s.warned=!0;var a=new Error("Possible EventEmitter memory leak detected. "+s.length+" "+String(t)+" listeners added. Use emitter.setMaxListeners() to increase limit");a.name="MaxListenersExceededWarning",a.emitter=e,a.type=t,a.count=s.length,function(e){console&&console.warn&&console.warn(e)}(a)}return e}function l(e,t,n){var r={fired:!1,wrapFn:void 0,target:e,type:t,listener:n},i=function(){for(var e=[],t=0;t<arguments.length;t++)e.push(arguments[t]);this.fired||(this.target.removeListener(this.type,this.wrapFn),this.fired=!0,d(this.listener,this.target,e))}.bind(r);return i.listener=n,r.wrapFn=i}function p(e,t,n){var r=e._events;if(void 0===r)return[];var i=r[t];return void 0===i?[]:"function"==typeof i?n?[i.listener||i]:[i]:n?function(e){for(var t=new Array(e.length),n=0;n<t.length;++n)t[n]=e[n].listener||e[n];return t}(i):f(i,i.length)}function h(e){var t=this._events;if(void 0!==t){var n=t[e];if("function"==typeof n)return 1;if(void 0!==n)return n.length}return 0}function f(e,t){for(var n=new Array(t),r=0;r<t;++r)n[r]=e[r];return n}Object.defineProperty(s,"defaultMaxListeners",{enumerable:!0,get:function(){return a},set:function(e){if("number"!=typeof e||e<0||o(e))throw new RangeError('The value of "defaultMaxListeners" is out of range. It must be a non-negative number. Received '+e+".");a=e}}),s.init=function(){void 0!==this._events&&this._events!==Object.getPrototypeOf(this)._events||(this._events=Object.create(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0},s.prototype.setMaxListeners=function(e){if("number"!=typeof e||e<0||o(e))throw new RangeError('The value of "n" is out of range. It must be a non-negative number. Received '+e+".");return this._maxListeners=e,this},s.prototype.getMaxListeners=function(){return c(this)},s.prototype.emit=function(e){for(var t=[],n=1;n<arguments.length;n++)t.push(arguments[n]);var r="error"===e,i=this._events;if(void 0!==i)r=r&&void 0===i.error;else if(!r)return!1;if(r){var o;if(0<t.length&&(o=t[0]),o instanceof Error)throw o;var s=new Error("Unhandled error."+(o?" ("+o.message+")":""));throw s.context=o,s}var a=i[e];if(void 0===a)return!1;if("function"==typeof a)d(a,this,t);else{var c=a.length,u=f(a,c);for(n=0;n<c;++n)d(u[n],this,t)}return!0},s.prototype.on=s.prototype.addListener=function(e,t){return u(this,e,t,!1)},s.prototype.prependListener=function(e,t){return u(this,e,t,!0)},s.prototype.once=function(e,t){if("function"!=typeof t)throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof t);return this.on(e,l(this,e,t)),this},s.prototype.prependOnceListener=function(e,t){if("function"!=typeof t)throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof t);return this.prependListener(e,l(this,e,t)),this},s.prototype.off=s.prototype.removeListener=function(e,t){var n,r,i,o,s;if("function"!=typeof t)throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof t);if(void 0===(r=this._events))return this;if(void 0===(n=r[e]))return this;if(n===t||n.listener===t)0==--this._eventsCount?this._events=Object.create(null):(delete r[e],r.removeListener&&this.emit("removeListener",e,n.listener||t));else if("function"!=typeof n){for(i=-1,o=n.length-1;0<=o;o--)if(n[o]===t||n[o].listener===t){s=n[o].listener,i=o;break}if(i<0)return this;0===i?n.shift():function(e,t){for(;t+1<e.length;t++)e[t]=e[t+1];e.pop()}(n,i),1===n.length&&(r[e]=n[0]),void 0!==r.removeListener&&this.emit("removeListener",e,s||t)}return this},s.prototype.removeAllListeners=function(e){var t,n,r;if(void 0===(n=this._events))return this;if(void 0===n.removeListener)return 0===arguments.length?(this._events=Object.create(null),this._eventsCount=0):void 0!==n[e]&&(0==--this._eventsCount?this._events=Object.create(null):delete n[e]),this;if(0===arguments.length){var i,o=Object.keys(n);for(r=0;r<o.length;++r)"removeListener"!==(i=o[r])&&this.removeAllListeners(i);return this.removeAllListeners("removeListener"),this._events=Object.create(null),this._eventsCount=0,this}if("function"==typeof(t=n[e]))this.removeListener(e,t);else if(void 0!==t)for(r=t.length-1;0<=r;r--)this.removeListener(e,t[r]);return this},s.prototype.listeners=function(e){return p(this,e,!0)},s.prototype.rawListeners=function(e){return p(this,e,!1)},s.listenerCount=function(e,t){return"function"==typeof e.listenerCount?e.listenerCount(t):h.call(e,t)},s.prototype.listenerCount=h,s.prototype.eventNames=function(){return 0<this._eventsCount?r(this._events):[]}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});function r(e,t){for(var n,r=[],i=e.split(/\r\n/),o=0;o<i.length;){var s=i[o];if(/^m=(?:audio|video)/.test(s))n={index:o,stripped:[]},r.push(n);else if(n){var a=/^a=rtpmap:(\d+) ([^/]+)\//.exec(s);if(a&&t===a[2]){i.splice(o,1),n.stripped.push(a[1]);continue}}o++}for(var c=0,u=r;c<u.length;c++){for(var d=u[c],l=i[d.index].split(" "),p=3;p<l.length;)-1===d.stripped.indexOf(l[p])?p++:l.splice(p,1);i[d.index]=l.join(" ")}return i.join("\r\n")}t.stripTcpCandidates=function(e){return e.sdp=(e.sdp||"").replace(/^a=candidate:\d+ \d+ tcp .*?\r\n/gim,""),Promise.resolve(e)},t.stripTelephoneEvent=function(e){return e.sdp=r(e.sdp||"","telephone-event"),Promise.resolve(e)},t.cleanJitsiSdpImageattr=function(e){return e.sdp=(e.sdp||"").replace(/^(a=imageattr:.*?)(x|y)=\[0-/gm,"$1$2=[1:"),Promise.resolve(e)},t.stripG722=function(e){return e.sdp=r(e.sdp||"","G722"),Promise.resolve(e)},t.stripRtpPayload=function(t){return function(e){return e.sdp=r(e.sdp||"",t),Promise.resolve(e)}},t.stripVideo=function(e){return e.sdp=function(e,n){var t=new RegExp("m="+n+".*$","gm"),r=new RegExp("^a=group:.*$","gm");if(t.test(e)){var i,o=(e=e.split(/^m=/gm).filter(function(e){if(e.substr(0,n.length)!==n)return!0;if(i=e.match(/^a=mid:.*$/gm)){var t=i[0].match(/:.+$/g);t&&(i=t[0].substr(1))}return!1}).join("m=")).match(r);if(o&&1===o.length){var s=o[0],a=new RegExp(" *"+i+"[^ ]*","g");s=s.replace(a,""),e=e.split(r).join(s)}}return e}(e.sdp||"","video"),Promise.resolve(e)},t.addMidLines=function(e){var t=e.sdp||"";if(-1===t.search(/^a=mid.*$/gm)){var n=t.match(/^m=.*$/gm),r=t.split(/^m=.*$/gm);n&&n.forEach(function(e,t){n[t]=e+"\na=mid:"+t}),r.forEach(function(e,t){n&&n[t]&&(r[t]=e+n[t])}),t=r.join(""),e.sdp=t}return Promise.resolve(e)}},function(e){e.exports={name:"ringcentral-web-phone",version:"0.8.1",scripts:{test:"npm run test:ut && npm run test:e2e","test:coverage":"cat .coverage/lcov.info | coveralls -v","test:e2e":"jest --config jest.config.e2e.js --runInBand","test:ut":"jest --config jest.config.ut.js",build:"npm run build:tsc && npm run build:webpack","build:tsc":"tsc","build:webpack":"cross-env NODE_ENV=production webpack --config webpack.config.js --progress --color",start:"webpack-dev-server --config webpack.config.js --progress --color",server:"http-server --port ${PORT:-8080}",watch:'npm-run-all --print-label --parallel "build:** -- --watch"',lint:"eslint --cache --cache-location node_modules/.cache/eslint --fix","lint:all":'npm run lint "src/**/*.ts" "demo/**/*.js"',"lint:staged":"lint-staged"},dependencies:{getstats:"1.2.0","sip.js":"0.13.5"},devDependencies:{"@types/expect-puppeteer":"3.3.1","@types/jest":"24.0.15","@types/jest-environment-puppeteer":"4.0.0","@types/node":"12.0.8",bootstrap:"3.4.1","cache-loader":"4.0.0","copy-webpack-plugin":"5.0.3",coveralls:"3.0.4","cross-env":"5.2.0",dotenv:"8.0.0",eslint:"6.8.0","eslint-config-ringcentral-typescript":"3.0.0","html-webpack-plugin":"3.2.0","http-server":"0.11.1",husky:"2.4.1","istanbul-instrumenter-loader":"3.0.1",jest:"24.8.0","jest-puppeteer":"4.2.0",jquery:"3.4.1","lint-staged":"8.2.1","npm-run-all":"4.1.5",puppeteer:"1.18.0",ringcentral:"3.2.2","ts-jest":"24.0.2","ts-loader":"6.0.3",typescript:"3.9.2","uglifyjs-webpack-plugin":"2.1.3",webpack:"4.35.0","webpack-cli":"3.3.4","webpack-dev-server":"3.7.2"},preferGlobal:!1,private:!1,main:"lib/index.js",types:"./lib/index.d.ts",author:{name:"RingCentral, Inc.",email:"devsupport@ringcentral.com"},contributors:[{name:"Kirill Konshin"},{name:"Elias Sun"}],repository:{type:"git",url:"git://github.com/ringcentral/ringcentral-web-phone.git"},bugs:{url:"https://github.com/ringcentral/ringcentral-web-phone/issues"},homepage:"https://github.com/ringcentral/ringcentral-web-phone",engines:{node:">=0.10.36"},license:"MIT"}}],i.c=s,i.d=function(e,t,n){i.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:n})},i.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},i.t=function(t,e){if(1&e&&(t=i(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var n=Object.create(null);if(i.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var r in t)i.d(n,r,function(e){return t[e]}.bind(null,r));return n},i.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return i.d(t,"a",t),t},i.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},i.p="",i(i.s=6)).default;function i(e){if(s[e])return s[e].exports;var t=s[e]={i:e,l:!1,exports:{}};return o[e].call(t.exports,t,t.exports,i),t.l=!0,t.exports}var o,s});